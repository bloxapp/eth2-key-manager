package signer

import (
	"encoding/base64"
	"encoding/hex"
	"encoding/json"
	"fmt"
	"testing"
	"time"

	"github.com/attestantio/go-eth2-client/spec"
	"github.com/attestantio/go-eth2-client/spec/altair"
	"github.com/attestantio/go-eth2-client/spec/bellatrix"
	"github.com/attestantio/go-eth2-client/spec/capella"
	"github.com/attestantio/go-eth2-client/spec/phase0"
	"github.com/stretchr/testify/require"

	eth2keymanager "github.com/bloxapp/eth2-key-manager"
	"github.com/bloxapp/eth2-key-manager/core"
	prot "github.com/bloxapp/eth2-key-manager/slashing_protection"
	"github.com/bloxapp/eth2-key-manager/wallets"
)

func testBlock(t *testing.T) *phase0.BeaconBlock {
	blockByts := []byte(`{"slot":"2","proposer_index":"2","parent_root":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","state_root":"0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","body":{"randao_reveal":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","eth1_data":{"deposit_root":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","deposit_count":"10","block_hash":"0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f"},"graffiti":"0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","proposer_slashings":[{"signed_header_1":{"message":{"slot":"1","proposer_index":"2","parent_root":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","state_root":"0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","body_root":"0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f"},"signature":"0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebf"},"signed_header_2":{"message":{"slot":"1","proposer_index":"2","parent_root":"0x010102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","state_root":"0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","body_root":"0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f"},"signature":"0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebf"}}],"attester_slashings":[{"attestation_1":{"attesting_indices":["1","2","3"],"data":{"slot":"100","index":"1","beacon_block_root":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","source":{"epoch":"1","root":"0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f"},"target":{"epoch":"2","root":"0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f"}},"signature":"0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebf"},"attestation_2":{"attesting_indices":["1","2","3"],"data":{"slot":"100","index":"1","beacon_block_root":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","source":{"epoch":"1","root":"0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f"},"target":{"epoch":"2","root":"0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f"}},"signature":"0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebf"}}],"attestations":[{"aggregation_bits":"0x010203","data":{"slot":"100","index":"1","beacon_block_root":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","source":{"epoch":"1","root":"0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f"},"target":{"epoch":"2","root":"0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f"}},"signature":"0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebf"}],"deposits":[{"proof":["0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f"],"data":{"pubkey":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f","withdrawal_credentials":"0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","amount":"32000000000","signature":"0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9f"}}],"voluntary_exits":[{"message":{"epoch":"1","validator_index":"2"},"signature":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f"}]}}`)
	blk := &phase0.BeaconBlock{}
	require.NoError(t, json.Unmarshal(blockByts, blk))
	return blk
}

// tested against a block and sig generated from https://github.com/prysmaticlabs/prysm/blob/master/shared/testutil/block.go#L86
func TestBenchmarkBlockProposal(t *testing.T) {
	require.NoError(t, core.InitBLS())

	// fixture
	sk := "5470813f7deef638dc531188ca89e36976d536f680e89849cd9077fd096e20bc"
	pk := "a3862121db5914d7272b0b705e6e3c5336b79e316735661873566245207329c30f9a33d4fb5f5857fc6fd0a368186972"
	domain := "0000000081509579e35e84020ad8751eca180b44df470332d3ad17fc6fd52459"
	blockByts := []byte(`{"slot":"1","proposer_index":"2","parent_root":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","state_root":"0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","body":{"randao_reveal":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","eth1_data":{"deposit_root":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","deposit_count":"10","block_hash":"0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f"},"graffiti":"0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","proposer_slashings":[{"signed_header_1":{"message":{"slot":"1","proposer_index":"2","parent_root":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","state_root":"0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","body_root":"0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f"},"signature":"0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebf"},"signed_header_2":{"message":{"slot":"1","proposer_index":"2","parent_root":"0x010102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","state_root":"0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","body_root":"0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f"},"signature":"0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebf"}}],"attester_slashings":[{"attestation_1":{"attesting_indices":["1","2","3"],"data":{"slot":"100","index":"1","beacon_block_root":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","source":{"epoch":"1","root":"0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f"},"target":{"epoch":"2","root":"0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f"}},"signature":"0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebf"},"attestation_2":{"attesting_indices":["1","2","3"],"data":{"slot":"100","index":"1","beacon_block_root":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","source":{"epoch":"1","root":"0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f"},"target":{"epoch":"2","root":"0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f"}},"signature":"0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebf"}}],"attestations":[{"aggregation_bits":"0x010203","data":{"slot":"100","index":"1","beacon_block_root":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","source":{"epoch":"1","root":"0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f"},"target":{"epoch":"2","root":"0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f"}},"signature":"0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebf"}],"deposits":[{"proof":["0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f","0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f","0x606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f"],"data":{"pubkey":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f","withdrawal_credentials":"0x202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f","amount":"32000000000","signature":"0x404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9f"}}],"voluntary_exits":[{"message":{"epoch":"1","validator_index":"2"},"signature":"0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f"}]}}`)
	sigByts := "aab8d1dc7e9fdea39b9a46cde64759138372a8d1226d56d01fa9e2df9e45e39d67bacf5794bb6841f5ea143aa124a33211089d4cc045e0605380bf4ae03291b1ee8082e55274ce5dc513cc0bebdb8e8a5276ad39a0cea3edd321d9cf854f695c"

	// setup KeyVault
	store := inmemStorage()
	options := &eth2keymanager.KeyVaultOptions{}
	options.SetStorage(store)
	options.SetWalletType(core.NDWallet)
	vault, err := eth2keymanager.NewKeyVault(options)
	require.NoError(t, err)
	wallet, err := vault.Wallet()
	require.NoError(t, err)
	k, err := core.NewHDKeyFromPrivateKey(_byteArray(sk), "")
	require.NoError(t, err)
	acc := wallets.NewValidatorAccount("1", k, nil, "", vault.Context)
	require.NoError(t, wallet.AddValidatorAccount(acc))

	// setup signer
	signer := NewSimpleSigner(wallet, &prot.NoProtection{}, core.PraterNetwork)

	// decode block
	blk := &phase0.BeaconBlock{}
	require.NoError(t, json.Unmarshal(blockByts, blk))

	versionedBeaconBlock := &spec.VersionedBeaconBlock{
		Version: spec.DataVersionPhase0,
		Phase0:  blk,
	}
	sig, _, err := signer.SignBeaconBlock(versionedBeaconBlock, _byteArray32(domain), _byteArray(pk))
	require.NoError(t, err)
	require.EqualValues(t, _byteArray(sigByts), sig)
}

// tested against a block and sig generated from https://github.com/prysmaticlabs/prysm/blob/hf1/shared/testutil/altair.go#L313-L438
func TestBenchmarkBlockProposalAltair(t *testing.T) {
	require.NoError(t, core.InitBLS())

	// fixture
	sk := "2799ceccbdaf1e36679b413193a363bfe6d2d35c8cf6ff6151165707461eaed7"
	pk := "b245d63d3f9d8ea1807a629fcb1b328cb4d542f35a3d5bc478be0df389dddd712fc4c816ba3fede9a96320ae6b24a7d8"
	domain := "000000004535ad2cc8e6d4f94cde8707ab5ef9a7d23f884df84c2531832a2b5e"
	blockSSZByts := "01000000000000001c00000000000000df7140ad4f8e394cab798d89fa7612a284de78aa004f6db9387a4269a4a0669c83387dd0abb441a3c16886c8144098cb4cac5e363516f329c368550094fd7ff754000000b1e2f27dfac80e4f1bce84adf11acf6cdbb0d8e59a575c9795020e614eb3aa29634108c0559c04ce02b93fc9a5a8daf60485ebac039864c79d51bef54915aa8c45cbcde3215f14962be196a6b8648851c35b4a804ce8d5fb6c5ff49800ef7740685b310217aa8ed11d15f0ac1df629f3dc95b9e0e8fc550025cb18ae36f8fb732000000000000000685b310217aa8ed11d15f0ac1df629f3dc95b9e0e8fc550025cb18ae36f8fb7300000000000000000000000000000000000000000000000000000000000000007c0100007c0100007c0100006502000065020000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa2ec291dd5e91096ae48b3659a7ac59567a48c030bb6ac9435d6d44ef39f3f664742f35b38cd6e41ade9ed417183cc0c0b407dfea8627ccc2275fc82ab3d2182e58a037eb144811d741d18894698396efde2b7873c2db9b712e03dfcd03705ef04000000e400000000000000000000000000000000000000df7140ad4f8e394cab798d89fa7612a284de78aa004f6db9387a4269a4a0669c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000df7140ad4f8e394cab798d89fa7612a284de78aa004f6db9387a4269a4a0669cb62ce3f28e8731dce73d5761fdc5e30383d42a022d6e939974d0586d82270f79b38b86d17237e4241a761e239c594e7a0d4ef731470001be3b125ba515f8f215f9309a9ba12653bf9d704a4125865b9775c8a65223e3ca027781175200a2d24403"
	sigByts := "ae37c5b026490df77d4757ad278f1a5f2c46c8971eaa9b62ad09534d3626b1d1da1371edeb061ed6f2f327f79d3bf79101941225dfb97af6d15c8fd6ac7ae8a180392a19aecec50c938b1ea6faf8ba848a4dc9a01f46502e98caec4a01b06575"

	// setup KeyVault
	store := inmemStorage()
	options := &eth2keymanager.KeyVaultOptions{}
	options.SetStorage(store)
	options.SetWalletType(core.NDWallet)
	vault, err := eth2keymanager.NewKeyVault(options)
	require.NoError(t, err)
	wallet, err := vault.Wallet()
	require.NoError(t, err)
	k, err := core.NewHDKeyFromPrivateKey(_byteArray(sk), "")
	require.NoError(t, err)
	acc := wallets.NewValidatorAccount("1", k, nil, "", vault.Context)
	require.NoError(t, wallet.AddValidatorAccount(acc))

	// setup signer
	signer := NewSimpleSigner(wallet, &prot.NoProtection{}, core.PraterNetwork)

	// decode block
	blk := &altair.BeaconBlock{}
	require.NoError(t, blk.UnmarshalSSZ(_byteArray(blockSSZByts)))

	versionedBeaconBlock := &spec.VersionedBeaconBlock{
		Version: spec.DataVersionAltair,
		Altair:  blk,
	}
	sig, _, err := signer.SignBeaconBlock(versionedBeaconBlock, _byteArray32(domain), _byteArray(pk))
	fmt.Println(hex.EncodeToString(sig))
	require.NoError(t, err)
	require.EqualValues(t, _byteArray(sigByts), sig)
}

// tested against a real block and sig from the Kiln testnet (slot 51793)
func TestBenchmarkBlockProposalBellatrix(t *testing.T) {
	require.NoError(t, core.InitBLS())

	// fixture
	sk := "2550fa1883222bd14d84ff3794ed555661bc8d00e9305387b308ab4d285105b6"
	pk := "99372f56eab6a56657006a831c6ffbad14a00b143eeb810364b0d6828f85414ae236980f93ef36a689f6d811352a6cf0"
	domain := "00000000e7acb21061790987fa1c1e745cccfb358370b33e8af2b2c18938e6c2"
	blockBase64 := "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"
	sigByts := "ae2605a0b64ababeaa41d27b60df1c716f9c180fb7b16d0d6c33743aa8ce3c387c870beec56dc7641d0824a130f3e68e1153cee3e243b033744092c833ac4fc86832b9158882f85747b1dfc0a9482924e7b40c4fd90fd65bcfe0f0cd75496971"

	// setup KeyVault
	store := inmemStorage()
	options := &eth2keymanager.KeyVaultOptions{}
	options.SetStorage(store)
	options.SetWalletType(core.NDWallet)
	vault, err := eth2keymanager.NewKeyVault(options)
	require.NoError(t, err)
	wallet, err := vault.Wallet()
	require.NoError(t, err)
	k, err := core.NewHDKeyFromPrivateKey(_byteArray(sk), "")
	require.NoError(t, err)
	acc := wallets.NewValidatorAccount("1", k, nil, "", vault.Context)
	require.NoError(t, wallet.AddValidatorAccount(acc))

	// setup signer
	signer := NewSimpleSigner(wallet, &prot.NoProtection{}, core.PraterNetwork)

	// decode block
	blk := &bellatrix.BeaconBlock{}
	blockBytes, err := base64.StdEncoding.DecodeString(blockBase64)
	require.NoError(t, err)
	require.NoError(t, blk.UnmarshalSSZ(blockBytes))

	versionedBeaconBlock := &spec.VersionedBeaconBlock{
		Version:   spec.DataVersionBellatrix,
		Bellatrix: blk,
	}
	sig, _, err := signer.SignBeaconBlock(versionedBeaconBlock, _byteArray32(domain), _byteArray(pk))
	require.NoError(t, err)
	require.EqualValues(t, _byteArray(sigByts), sig)
}

func TestBenchmarkBlockProposalCapella(t *testing.T) {
	require.NoError(t, core.InitBLS())

	// fixture
	sk := "2550fa1883222bd14d84ff3794ed555661bc8d00e9305387b308ab4d285105b6"
	pk := "99372f56eab6a56657006a831c6ffbad14a00b143eeb810364b0d6828f85414ae236980f93ef36a689f6d811352a6cf0"
	domain := "00000000e7acb21061790987fa1c1e745cccfb358370b33e8af2b2c18938e6c2"
	blkByts := _byteArray("02000000000000000200000000000000000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f54000000000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f0a00000000000000202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f84010000240300002805000013060000eb0a0000000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f605b0b0000eb1e000001000000000000000200000000000000000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebf01000000000000000200000000000000010102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebf040000000800000004010000e400000064000000000000000100000000000000000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f0100000000000000202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f0200000000000000404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebf010000000000000002000000000000000300000000000000e400000064000000000000000100000000000000000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f0100000000000000202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f0200000000000000404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebf01000000000000000200000000000000030000000000000004000000e400000064000000000000000100000000000000000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f0100000000000000202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f0200000000000000404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebf010203000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f0040597307000000404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9f01000000000000000200000000000000000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f17f4eeae822cc81533016678413443b95e34517e67f12b4a3a92ff6b66f972ef58e809c71e4885cb7b3f1d5c793ab04ed239d7793d6e230e6eceb8f3db582777b1500b8b31b9d268339e7b32bba8d6f1311b211dea760203509bdde017a506b12c825976d12b04db7bce9eca9e1ed007056a3f360c803a8d3c6642adee3185bd914c599317d96487831dabda82461f65700b2528781bdadf785664f9d8b11c4ee1139dfeb056125d2abd67e379cabc6d58f1c3ea304b97cf17fcd8a4c53f4dedeaa041acce062fc8fbc88ffc111577db4a936378749f2fd82b4bfcb880821dd5cbefee984bc1ad116096a64a44a2aac8a1791a7ad3a53d91c584ac69a8973daed6daee4432a198c9935fa0e5c2a4a6ca78b821a5b046e571a5c0961f469d40e429066755fec611afe25b560db07f989933556ce0cea4070ca47677b007b4b9857fc092625f82c84526737dc98e173e34fe6e4d0f1a400fd994298b7c2fa8187331c333c415f0499836ff0eed5c762bf570e67b4476ff751467270668df463600d26dba58297a986e649bac84ea856712d4779c00e0a9bca483b86829a24748126e17835d2d9b3fe26a1f594d2dccbc4eab7d3618000200008f21a69269874353850128dcb717dd4478af029aaa923f99d55bebafb54342c442c294e902bfc9884c1ce5fef156d4661bb8f0ff488bface37f18c3e7be64b0f0202000064130000c64828000000a60100008d0300001706000035090000b90a00005b0c0000420e0000910e000044110000101b883470f1cb7e0a74561be59e08a6eff6aedd3408c190fd359f0bfb628d2461354b7fe4fdad4b8e72b8775cd44e339ad6b5f22a8f53c418bda2b01200a07f1fe3d010bbb96f5ca0d4919192370c15bc46ed455c797b1b11154be359638f9e487121182fae03a7d26012ed7c85b64a63aa5d56a98ac589f9950a9f5bf1a42c1eea245a98f2f4e743c5f8eac1584893104853dc1b5576826156b371a50c59bcb238d0794a185dc0816dbd8c10a0b0e1b8fbe01c4e8dd719f1e4e9b2ded8613f87f1d01e3ea28e9311d135301b2d1260e4811789e1ecbc33e573346f4da94f4c272e21e23b1d414706429c7f0b40c3de243894349c4a59ece791e5fd086897aef81fc23e4d55bb52b28174c3fa9f2c44d370fbbac1dee561f120560c3dda34a731d4618fd22d595b725efa87bb62f8f93bd7d906c4782a647e2cb14ed293e58bc793852058ab5e6f3df76b30e99102b82c8e7d005e1b675fc74b95032616c590ff08da710dd085be570cc0b2c13891625b44b5b3e1846606c39ad39bb72b4b5edff58cf95969ead0470ab897da6c9d69b517e07fd4ed8fa48c14284a5a060ecb745f66cf1be55fb4905d62d8d376865f7d2d1816844fc4719f5d79ab905474d00f62aed6692e5a93be1b32740a8083fc2a61b0e1fc13ad409410d37f3cb0a5275c966abab015047c15251cd301cd31a7b2a0502f7f953e672d61606616b16d5117163064fb33d97eb566f7fce5f01d3833343c1c97e6221f9f0798415f3a4b87fd472e53a24c1a101e1dd55c8f65c2c0f4ccc4b46a133fda49db5dba96631b4cfd1a05662e42a8e15a26d3148a70be305c85f87dae4217fb91498c4098b946a9042355968b765e2e62bb0cf26d59e534c3af8795fa0f4a44ed0d39d258acd934c3416e4d4a738eaa473526d99bee037765d5f6034c830eb766ef067a1468630fbb65b7c5a862017fe84d4d1961f90c37f18a4bd2509fe2e96cb1e26971900e20295c8a9e9ed77b348d4509a8425090318be5c9d2bcda36bdfabb71bfb36755794f78c877df2825bd736a358933af77eae6edf701ed7ef168f57f677df3445d89c5eefc783184eadd3886fcfd75f5f142bc10904a019acdf7861caa7e0fba3e7831b0a549a56c0f174e80cffb8992346ddf7ce4eeff9e335531df3dff57d5f539bc0d3eac57f70a8f973e0864c87b25c3e0bea72e05eda8a120178186dfbfaa9a00f904f23a452af990975c3bcafee7bde4738fdf32b8479be0e9e30b11b0ccbf31a6f884f4098e47759b7a3eb7d7bd0cfa2510dd654b28d664696aca987f55c7bfe73be1cc70a768cdb2594a13a763dbb991186b8b8b2e913857aadc08f940239d03a0b181ae849d557da5b54bfc966231690bb4660e083cdae28caf8ed33e3f66672772ea827253421bade013af57a290a915dbc777f2afccd9cb29e260ecc5ea54cd3a1e25cf66f2937f8061b3ba6b1ebf3129568f16e3dd04d5c50992cc348f3e615af346dbf2c144aeb19932dcfbff0221fae0ed9706b53245176630d011b9cd2d8630848ab1196cf9a3cc0d94392df4295be246e0ac24545c2715a40dcbc57aabffd0a86acec362affaf1bafc5c75b7ca28698a1ac14ea2c8def8ac1a32d3bf65b98aac7d0cb6fd93e5ff16274ad6d0eedf773694f29fc7a234deebc893e4cea4a5483d876e4f35019d6a62f1c407739b68b7a9f5408b4fb854534344fbffe3239feb17c0e7ac269b447bc6246579e1208b6904751eeacb985cbd43bb7792de0b428f1476301c479a3922f61f650c8298fb0b7584b52c7bfcf4dfe51335ab68d571c5815fc78d772346b0b13dbbb8906f076a0452e7e7a414e005dc37cfee85810eccab5999e2d43e13709bf66e8a8936a4283885b158115050789d3b4d9c8dc8026ac720069d78d47dd5e183032f9c53d4c57640fcd6207118d9738f00cd5ddf587f3a7c401d923aa2fb08dba1768728001abc3436cc2b5cf978b558ae58a0578344e7464cd00e719135c70244e2faf1264571a8999789c26f401753e429a1135f18906ebef19e122489622738724a6424cad363bed43304c1285c8da4824fec75d7c51b0a34070d8b976e8e8c8fd50908a7e440092dddd970fd55793e2a4446342bd3daf5b96220977d8f0c0877448694993717a89c57b63640612ac4b0258cb5fdda4a311650c631c35c7313b6d2a094fdb207857d94500c37ab20ea0aa54af951fb04584a37b857981c6d13922e95cfecb70b69ab9a57ee6c13ccf8aa38c52de008ec16d9090aa4bf15db2f4afcdbb1bf4920efe5a1aeeff2c949d43460d67837af87bcdffd9e972340cb40de6d87fa11d83bbfb29e97ef2509097e8dec69a1318132a5dd7d95c1c1e13cc85d37a33c9f7d52379b4a47bf889903c8f3ebd2800526d0916e1aad00e02b682e55bc2865c3ff4ce0cc6aad1bd7d8e2901ea53f3a5e2c025dbb9a00f0ce88583c1dbd3d491ed04ba8260dc06fdb8a9162e022c75e9f057da0abed537b34214df234e1f8b26e7374cfa5470272ef03f7b41f7ed067c4c6011c8a17b2e65340e36af81ecb86420755fe5a0413495e16fabee3f9e5524ab7b12a3cffe20b1df7be32434d7da3fb1f3e9b16f42a4f550501120036b193701ac9eb6f760c2da70e3175a66b10463e43c0442a56217ca7cd25fdb46f3eff28cf1bdfe1b7eb3bf9e85ad8ffde207529c9bb1094dbae4db04a4bff6571c985bd629cdc2b78f739eca6694f32fded6944202859277740267d5dc4c1f74ddd1401c6d514ce23b885723c4618789b5c2ddeffec2179be8dec1347ca4ebed5e8bb10d7d17d41c9709a978fc6189f0c3d49d1b7f41bf8f1dc112f2ece84b6c6a687f44b95e62d274f89fa07bd0d3fdd3ee2a97233e363329ef7096ae5a45b2982859e983f5d989a928e9b88579308ece2391dbde378b81a54d38b3f81225d59f8bb511ba7eb590154ceb8258b804b6da98b3af6f395f5b3f1d12f5fd3c29ef54f31ccea0a36ec2daec0a87030daba8d079093ddde17871c4aa1a7dc3dbd4d760be2152dc250ca2bba34a55daf257b9e3704c3ee244081524cb1ae7c22a0d22f1c65b88b1e534ea1cb8f75cea4a7c03d6786f85327876da72dff1d4d049b51ecc10124279a0cbc151e76ddd475cf3dfeede59a902f4c7145786b5993c8bf8016265ec36298b27d0c6a21c7484fc01a8f14c8c287d14ab86789e34699fdb57f6c43486f0fd9013f2f2c62c60b75b1dc3e4d38a6f7c06e7029f874a204b059d834ffb44c99f843ae33ed0950259310d5134d22e0ef42c3686b2adadc6cd1ae7d7836ac71a69d8ba2d02d0152c320610c12c57cba182c5d1e21198e787b21d0c522106aa8243ec994c4ea0b7959a3269d13566f3d0a3eb5ed276d9e22b33fc12e26cafde04b24ec0fd90455dc26d30a9fc25588b762681ca69aecc19e7971dd4cd063d4e31ee99f3c82015ed9a70e58b9d7cd9a8de38eba90ceffc629e7d6c06e4f2fe9cd45bae557652fe58cc9be54de9a994bf14c3bce787a106778416fbe966e95e51a35ba78d3dc4e4f7551e2791af00d50362493697d55ea6718ba2f089eda330e26100fb5adbb939afaf74982795414422712e8560cec372eaf1a56b50ba4e00e42b145537e94e88eddd7d200d0153edb6dcc12eb298666b0aef9ea495fccfda06b7affe7227bceb41d9ac9dd150df8642cdb11df5ab92b69629b6a5ccdc7ba92b6cf12172217057d291b2fdc6f104e86617be1b7fffeb36af59a018f50c055e24ef9b6daff839083bc9dfeae9101f6aff49f808f603834802d160283cd71b275bf97eb49f5612215cc8fe93875fa082adb51ff0dca75ff57ba7852d794284db5b8d498002a821e5fc2c57a27cc1fe591f12860895b0057bc75ecbff9824bb46e2af06a785b6adfa9e32f49d6235776c3bcace18b330cec1126ac2bb5f3679339037817eab536fed29fe5c62ef790cb74893f1524280b0111e24fc0172130d00a88361e63511eb56a96e552d02c4944544c193189a152844ca49cadae38b7424426a74d61763716a068ba5ca9f3bdc2e0e9b644f1f2e02596bd3f446bb9f13dfb18ad2c9a2ba97771bb994f801affe2e8dda8d638e366c5b8263cc891a8a35e52c79f0856bfeaf0719bd1bfb54acc467783b6c08e55491d39b20f218342991381c38d357a4659baf8d44ddf5045d7f116bcc55f78c28a0dc100d06dff44e639b8e7adf967816c03de54eccdf9f6402a2806889d2cd980f34e5197771f13f1fa6b8c7c732031664bb675ff12d642ae62459e92b1cc28c62349e1636850b8a3ff411e1f14b097f7fa3b23eaa173d17a13f0703eecd7358aa623057325eed381a2ba13c50a13a3d8adaad0295960d925709d6e7cb101e894d9ae8db3dcb82a45570b6e02ab68aa4ea94f8779a9c45a559971ea3e9ec7ac8a144753ec38e78401b14b489a79266dd0527a4505adca584fe7406d9f7f05ef46d262384fbf1c0607f745a40681d4855aa34c37375b2cf7c99d46b6ae4e3aa9ee209782dce9d167bbff79686e59426a0513b951818ee02a9ea5ed8bcd0f991f46eee44c6e82fc6d07823a9f44f2fd7bfa0e250d6699cf7ad2577eb9eaf0dd9b1595cf018383c3d45956e508fa982bbb7744522a03bac5cba22f58a41801f579434126f5b866dcc6ca0454e9be1c7f2f6649254f3cc09142068f412d5d454b4e4d5b54e459719550f2df1901a18467d9d5297ed4a9eedb9f402f2bfd4bd2e50ab697ea5bef5e7e8082650b823635a4f0f55c18712d0f4d365824c79827d454425aec0b4ea6561ce3f1c5411ab4dff26e2412791cdaa28bf6c8fa53af412828c599d7876508f78f2c82ee67e8357947c6848af143fc5d20409049925cd1b194244466711ce7c34a72a165392564b96e280406a95da927d14ebbb6b999ef446d5ad49881c219dac8ad02d994e059569e91b84f211a4c39a3fbd594a8c835aa5976e0c8899d81a5abaa14301662b9e14fb96ea89862ad898cd7d77bcd2547f0f40471f86d4a4f26e4274f2e95fd9b2b604de867be95630b1ea6ce45ba79acc81b986605e46acda208bd3302ffcc6e83f91bff8362b3f9641ca0227d8b31341e3200032b2acf1e7e043b2c38ea1750a6c31f174b0a8b00137ec3eea24ed9fdf979bf04ed923a2cf5cc05a9acf697d27ccdb2a903a4846729cd9b2eead414da983d4f5bfd0ff4f2e7eb75988e58c3a635c271ce0c3b31143f1d68987deaac86a1e079deb07b3d2d497de5ebe8d94486e9a7b300c691621a68b3af4fee781c7c05a931123f910054d096c2e154950d32a26c38edb70dda50a242be4d15ce60c265767b141011cd84aa585c3af798fc1eb5ea63e93e0a426c3e1468f402f7e64f20281a4bd73cc1234174f1762a9a41989f570997036c885b1fdbf9c8153a1d19afb6526a123ca6a2fe6e98c6009f8439f6b6eea881453cc58ef344338ffd04783ce9c28c2e373812a65157643f679ed99ab35f4024e6ee31877e536b03c38616fccc993365143ddaffce39c805b391674070e993c6464156043a84266860c769de218bb5f5698f4c7a9b74142535cbcc08d5b3f747cbf6a7dfbb6c7b0ccc58af4886bc441558496e9c84d80660117777f01cdb84c0a2d3b0f2d8a6eacff5a0e55bd1be6387c3793ae8f5231c59697ae914894a49b3ae13a3a124cbf6cea33b7eb575cf6cd13e6073ddf4d033a3f87366c27089afc03707ef9a44c828388733d70f09bc08de574d07cf193f0a26a08ce8253bfdb26d5306632012c6dae194783deb31b72ac35bbd57f07f1667746d85f5d5b2132b885f8cb0206949780f9406307396dc7ece7938225fc5a55c65ed3608c27f668ba9b08875979e249655d15a4c3d77b1433ab26f56d80e2ca9178d88501ee682a14d07b17635e9968da2d98aa9eb4a5ae639e42eed0c7735313d3308fd079589d5cb2dd381a9298f67325976a6dcd3e38f836e4bc3106885f6348c57c90beadd7cbca17570b90130aaadc7eb0ed2bfb97c5c8a791d0b6b2736d43b0f444909449e6ea32ba706ddfe28c407a85e82e3f22064696d2fd7b37b33e01e0016ad91047f95f0cf5c5d6abc8fd7698c4155c290a1a1db842e77e656c69ad8bc06cea9e00dadbec886ca64af5fe3045ebc8c549bf23e71c634f02da8b250618c169a54e4af45d799f2de6747bde01395a13f1a605e9be59ced04a51e77ed0730f3420571164ea5247a670b962ebf6b453660748ca502000000000000000300000000000000000102030405060708090a0b0c0d0e0f10111213000064a7b3b6e00d0200000000000000b89bebc699769726a318c8e9971bd3171297c61aea4a6578a7a4f94b547dcba5bac16a89108b6b6a1fe3695d1a874a0b000102030405060708090a0b0c0d0e0f10111213000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f")
	sigByts := "b607bfb5b16c88cdf69c62db8c0815db5c08625b23574776c43a775ebd82dfc21c7839fc3e12fcbec84ee0b296e090510b2e6c6f4224228fdbc3ab1a389a638d12ff7fa2df15755978c7c3c0a923d7d96e79a2fc5f9c604f169e0dc167d2123c"

	// setup KeyVault
	store := inmemStorage()
	options := &eth2keymanager.KeyVaultOptions{}
	options.SetStorage(store)
	options.SetWalletType(core.NDWallet)
	vault, err := eth2keymanager.NewKeyVault(options)
	require.NoError(t, err)
	wallet, err := vault.Wallet()
	require.NoError(t, err)
	k, err := core.NewHDKeyFromPrivateKey(_byteArray(sk), "")
	require.NoError(t, err)
	acc := wallets.NewValidatorAccount("1", k, nil, "", vault.Context)
	require.NoError(t, wallet.AddValidatorAccount(acc))

	// setup signer
	signer := NewSimpleSigner(wallet, &prot.NoProtection{}, core.PraterNetwork)

	// decode block
	blk := &capella.BeaconBlock{}
	require.NoError(t, blk.UnmarshalSSZ(blkByts))

	versionedBeaconBlock := &spec.VersionedBeaconBlock{
		Version: spec.DataVersionCapella,
		Capella: blk,
	}
	sig, _, err := signer.SignBeaconBlock(versionedBeaconBlock, _byteArray32(domain), _byteArray(pk))
	require.NoError(t, err)
	require.EqualValues(t, _byteArray(sigByts), sig)
}

func TestProposalSlashingSignatures(t *testing.T) {
	seed, _ := hex.DecodeString("0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1fff")
	signer, err := setupWithSlashingProtection(t, seed, true, true)
	require.NoError(t, err)

	t.Run("valid proposal", func(t *testing.T) {
		blk := testBlock(t)
		blk.Slot = 99
		versionedBeaconBlock := &spec.VersionedBeaconBlock{
			Version: spec.DataVersionPhase0,
			Phase0:  blk,
		}
		_, _, err = signer.SignBeaconBlock(versionedBeaconBlock, _byteArray32("0000000081509579e35e84020ad8751eca180b44df470332d3ad17fc6fd52459"), _byteArray("95087182937f6982ae99f9b06bd116f463f414513032e33a3d175d9662eddf162101fcf6ca2a9fedaded74b8047c5dcf"))
		require.NoError(t, err)
	})

	t.Run("valid proposal, sign using nil pk. Should error", func(t *testing.T) {
		blk := testBlock(t)
		blk.Slot = 99
		versionedBeaconBlock := &spec.VersionedBeaconBlock{
			Version: spec.DataVersionPhase0,
			Phase0:  blk,
		}
		_, _, err = signer.SignBeaconBlock(versionedBeaconBlock, _byteArray32("0000000081509579e35e84020ad8751eca180b44df470332d3ad17fc6fd52459"), nil)
		require.NotNil(t, err)
		require.Error(t, err, "account was not supplied")
	})

	t.Run("double proposal, different state root. Should error", func(t *testing.T) {
		blk := testBlock(t)
		blk.Slot = 99
		blk.StateRoot = _byteArray32("0000000081509579e35e84020ad8751eca180b44df470332d3ad17fc6fd52459")
		versionedBeaconBlock := &spec.VersionedBeaconBlock{
			Version: spec.DataVersionPhase0,
			Phase0:  blk,
		}

		_, _, err = signer.SignBeaconBlock(versionedBeaconBlock, _byteArray32("0000000081509579e35e84020ad8751eca180b44df470332d3ad17fc6fd52459"), _byteArray("95087182937f6982ae99f9b06bd116f463f414513032e33a3d175d9662eddf162101fcf6ca2a9fedaded74b8047c5dcf"))
		require.NotNil(t, err)
		require.EqualError(t, err, "slashable proposal (HighestProposalVote), not signing")
	})

	t.Run("double proposal, different body root. Should error", func(t *testing.T) {
		blk := testBlock(t)
		blk.Slot = 99
		versionedBeaconBlock := &spec.VersionedBeaconBlock{
			Version: spec.DataVersionPhase0,
			Phase0:  blk,
		}

		copy(blk.Body.Graffiti[:], "different body root")
		_, _, err = signer.SignBeaconBlock(versionedBeaconBlock, _byteArray32("domain"), _byteArray("95087182937f6982ae99f9b06bd116f463f414513032e33a3d175d9662eddf162101fcf6ca2a9fedaded74b8047c5dcf"))
		require.NotNil(t, err)
		require.EqualError(t, err, "slashable proposal (HighestProposalVote), not signing")
	})

	t.Run("double proposal, different parent root. Should error", func(t *testing.T) {
		blk := testBlock(t)
		blk.Slot = 99
		blk.ParentRoot = _byteArray32("0000000081509579e35e84020ad8751eca180b44df470332d3ad17fc6fd52458")
		versionedBeaconBlock := &spec.VersionedBeaconBlock{
			Version: spec.DataVersionPhase0,
			Phase0:  blk,
		}

		_, _, err = signer.SignBeaconBlock(versionedBeaconBlock, _byteArray32("domain"), _byteArray("95087182937f6982ae99f9b06bd116f463f414513032e33a3d175d9662eddf162101fcf6ca2a9fedaded74b8047c5dcf"))
		require.NotNil(t, err)
		require.EqualError(t, err, "slashable proposal (HighestProposalVote), not signing")
	})

	t.Run("double proposal, different proposer index. Should error", func(t *testing.T) {
		blk := testBlock(t)
		blk.Slot = 99
		blk.ProposerIndex = 3
		versionedBeaconBlock := &spec.VersionedBeaconBlock{
			Version: spec.DataVersionPhase0,
			Phase0:  blk,
		}

		_, _, err = signer.SignBeaconBlock(versionedBeaconBlock, _byteArray32("domain"), _byteArray("95087182937f6982ae99f9b06bd116f463f414513032e33a3d175d9662eddf162101fcf6ca2a9fedaded74b8047c5dcf"))
		require.NotNil(t, err)
		require.EqualError(t, err, "slashable proposal (HighestProposalVote), not signing")
	})
}

func TestFarFutureProposalSignature(t *testing.T) {
	seed := _byteArray("0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1fff")
	network := core.PraterNetwork
	maxValidSlot := network.EstimatedSlotAtTime(time.Now().Unix() + FarFutureMaxValidEpoch)

	t.Run("max valid source", func(tt *testing.T) {
		signer, err := setupWithSlashingProtection(t, seed, true, true)
		require.NoError(t, err)

		blk := testBlock(t)
		blk.Slot = maxValidSlot
		versionedBeaconBlock := &spec.VersionedBeaconBlock{
			Version: spec.DataVersionPhase0,
			Phase0:  blk,
		}

		_, _, err = signer.SignBeaconBlock(versionedBeaconBlock, _byteArray32("0000000081509579e35e84020ad8751eca180b44df470332d3ad17fc6fd52459"), _byteArray("95087182937f6982ae99f9b06bd116f463f414513032e33a3d175d9662eddf162101fcf6ca2a9fedaded74b8047c5dcf"))
		require.NoError(t, err)
	})
	t.Run("too far into the future source", func(tt *testing.T) {
		signer, err := setupWithSlashingProtection(t, seed, true, true)
		require.NoError(t, err)

		blk := testBlock(t)
		blk.Slot = maxValidSlot + 1
		versionedBeaconBlock := &spec.VersionedBeaconBlock{
			Version: spec.DataVersionPhase0,
			Phase0:  blk,
		}

		_, _, err = signer.SignBeaconBlock(versionedBeaconBlock, _byteArray32("0000000081509579e35e84020ad8751eca180b44df470332d3ad17fc6fd52459"), _byteArray("95087182937f6982ae99f9b06bd116f463f414513032e33a3d175d9662eddf162101fcf6ca2a9fedaded74b8047c5dcf"))
		require.EqualError(t, err, "proposed block slot too far into the future")
	})
}
